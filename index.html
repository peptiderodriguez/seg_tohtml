<!DOCTYPE html>
<html>
<head>
    <title>Combined MK+HSPC Review (Separate Sets)</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: monospace; background: #0a0a0a; color: #ddd; padding: 20px; }

        .header { background: #111; padding: 20px; border: 1px solid #333; margin-bottom: 20px; text-align: center; }
        h1 { font-size: 1.5em; font-weight: normal; margin-bottom: 15px; }

        .stats { display: flex; justify-content: center; gap: 30px; margin: 20px 0; }
        .stat { padding: 15px 30px; background: #1a1a1a; border: 1px solid #333; }
        .stat .number { display: block; font-size: 2em; margin-top: 10px; }

        .note { text-align: center; margin: 20px 0; padding: 15px; background: #111; border: 1px solid #333; border-left: 3px solid #555; }

        .section { margin: 40px 0; }
        .section h2 { font-size: 1.3em; margin-bottom: 15px; padding: 10px; background: #111; border: 1px solid #333; border-left: 3px solid #555; }

        .controls { text-align: center; margin: 30px 0; }
        .btn { padding: 15px 30px; background: #1a1a1a; border: 1px solid #333; color: #ddd; cursor: pointer; font-family: monospace; font-size: 1.1em; margin: 10px; text-decoration: none; display: inline-block; }
        .btn:hover { background: #222; }
        .btn-primary { border-color: #4a4; color: #4a4; }
        .btn-clear { border-color: #a44; color: #a44; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Combined MK + HSPC Review</h1>
        <p style="color: #888;">All slides combined - Phase 1 (2% sample) - Separate annotation sets</p>

        <div class="stats">
            <div class="stat">
                <span>Total MKs</span>
                <span class="number">1,195</span>
            </div>
            <div class="stat">
                <span>Total HSPCs</span>
                <span class="number">21,922</span>
            </div>
            <div class="stat">
                <span>MK Annotations</span>
                <span class="number" id="mk-annotation-count">0</span>
            </div>
            <div class="stat">
                <span>HSPC Annotations</span>
                <span class="number" id="hspc-annotation-count">0</span>
            </div>
        </div>

        <div class="note">
            âš  MKs and HSPCs are now <strong>completely separate</strong> - each with their own pages and annotations
        </div>
    </div>

    <div class="section">
        <h2>ðŸ”´ Megakaryocytes (MKs)</h2>
        <div class="controls">
            <a href="mk_page1.html" class="btn btn-primary">Review MKs â†’</a>
            <button class="btn" onclick="exportCellTypeAnnotations('mk', 4)">Export MK Annotations</button>
            <span style="margin: 0 20px; color: #888;">4 pages â€¢ ~300 per page</span>
        </div>
    </div>

    <div class="section">
        <h2>ðŸ”µ HSPCs</h2>
        <div class="controls">
            <a href="hspc_page1.html" class="btn btn-primary">Review HSPCs â†’</a>
            <button class="btn" onclick="exportCellTypeAnnotations('hspc', 74)">Export HSPC Annotations</button>
            <span style="margin: 0 20px; color: #888;">74 pages â€¢ ~300 per page</span>
        </div>
    </div>

    <div class="controls">
        <button class="btn" onclick="exportAllAnnotations()">Export All Annotations (MK + HSPC)</button>
        <button class="btn btn-clear" onclick="clearAllAnnotations()">Clear All Annotations</button>
    </div>

    <script>
        function updateAnnotationCounts() {
            let mkAnnotations = 0;
            let hspcAnnotations = 0;

            const allKeys = Object.keys(localStorage);

            for (const key of allKeys) {
                if (key.startsWith('mk_labels_page')) {
                    try {
                        const labels = JSON.parse(localStorage.getItem(key));
                        mkAnnotations += Object.keys(labels).length;
                    } catch(e) {}
                } else if (key.startsWith('hspc_labels_page')) {
                    try {
                        const labels = JSON.parse(localStorage.getItem(key));
                        hspcAnnotations += Object.keys(labels).length;
                    } catch(e) {}
                }
            }

            document.getElementById('mk-annotation-count').textContent = mkAnnotations.toLocaleString();
            document.getElementById('hspc-annotation-count').textContent = hspcAnnotations.toLocaleString();
        }

        function exportCellTypeAnnotations(cellType, totalPages) {
            const allLabels = {};

            for (let page = 1; page <= totalPages; page++) {
                const key = `${cellType}_labels_page${page}`;
                const pageLabels = localStorage.getItem(key);
                if (pageLabels) {
                    try {
                        const parsed = JSON.parse(pageLabels);
                        Object.assign(allLabels, parsed);
                    } catch(e) {
                        console.error(`Failed to parse ${key}:`, e);
                    }
                }
            }

            const annotatedCount = Object.keys(allLabels).length;

            if (annotatedCount === 0) {
                alert(`No ${cellType.toUpperCase()} annotations to export`);
                return;
            }

            const blob = new Blob([JSON.stringify(allLabels, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${cellType}_labels_all.json`;
            a.click();
            URL.revokeObjectURL(url);

            alert(`Exported ${annotatedCount} ${cellType.toUpperCase()} annotations`);
        }

        function exportAllAnnotations() {
            const mkLabels = {};
            const hspcLabels = {};

            for (let page = 1; page <= 4; page++) {
                const key = `mk_labels_page${page}`;
                const pageLabels = localStorage.getItem(key);
                if (pageLabels) {
                    try {
                        const parsed = JSON.parse(pageLabels);
                        Object.assign(mkLabels, parsed);
                    } catch(e) {}
                }
            }

            for (let page = 1; page <= 74; page++) {
                const key = `hspc_labels_page${page}`;
                const pageLabels = localStorage.getItem(key);
                if (pageLabels) {
                    try {
                        const parsed = JSON.parse(pageLabels);
                        Object.assign(hspcLabels, parsed);
                    } catch(e) {}
                }
            }

            const mkCount = Object.keys(mkLabels).length;
            const hspcCount = Object.keys(hspcLabels).length;

            if (mkCount === 0 && hspcCount === 0) {
                alert('No annotations to export');
                return;
            }

            const combined = {
                mk: mkLabels,
                hspc: hspcLabels,
                metadata: {
                    mk_count: mkCount,
                    hspc_count: hspcCount,
                    export_date: new Date().toISOString()
                }
            };

            const blob = new Blob([JSON.stringify(combined, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'all_labels_combined.json';
            a.click();
            URL.revokeObjectURL(url);

            alert(`Exported ${mkCount} MK + ${hspcCount} HSPC annotations`);
        }

        function clearAllAnnotations() {
            if (!confirm('Clear ALL annotations for both MKs and HSPCs? This cannot be undone.')) return;

            const keysToDelete = Object.keys(localStorage).filter(key =>
                key.startsWith('mk_labels_') || key.startsWith('hspc_labels_')
            );

            keysToDelete.forEach(key => localStorage.removeItem(key));

            alert(`Cleared ${keysToDelete.length} annotation pages.`);
            location.reload();
        }

        updateAnnotationCounts();
    </script>
</body>
</html>